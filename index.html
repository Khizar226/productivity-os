<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taska - Ultimate Project Management</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151f32', 900: '#0f172a' },
                        primary: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' }
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s ease-out',
                        'fade-in': 'fadeIn 0.5s ease-out'
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }
                    }
                }
            }
        }
    </script>
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .hidden-section { display: none !important; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e2e8f0; }
        .dark .calendar-grid { background: #334155; }
        .calendar-day { min-height: 100px; background: white; padding: 4px; }
        .dark .calendar-day { background: #0f172a; }
        #chat-panel { transition: transform 0.3s ease-in-out; }
        #chat-panel.open { transform: translateX(0); }
        .dropdown-menu { display: none; }
        .dropdown-menu.show { display: block; animation: fadeIn 0.2s ease-out; }
        #sidebar { transition: margin-left 0.3s ease-in-out; }
        .mobile-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; display: none; }
        .mobile-overlay.open { display: block; }
        
        /* Print Styles */
        @media print {
            #sidebar, #header-area, #mobile-fab, #project-actions, .no-print { display: none !important; }
            #main-app { height: auto; overflow: visible; }
            #view-list, #view-table { overflow: visible; height: auto; }
            body, #main-app, .bg-slate-50, .dark .bg-slate-900 { background: white !important; color: black !important; }
            .print-only { display: block !important; }
            .card { border: 1px solid #ddd; break-inside: avoid; }
        }
    </style>
</head>

<body class="bg-white text-slate-800 h-screen flex flex-col dark:bg-slate-900 dark:text-slate-100 transition-colors duration-200">

    <div id="loading-overlay" class="fixed inset-0 bg-white dark:bg-slate-900 z-[100] flex flex-col items-center justify-center">
        <div class="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-slate-500 font-medium">Loading Taska...</p>
    </div>

    <audio id="alarm-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <div id="landing-page" class="hidden-section min-h-screen flex flex-col">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <img src="taska-logo-226.png" class="w-8 h-8 object-contain" alt="Taska">
                <span class="font-bold text-xl tracking-tight dark:text-white">Taska</span>
            </div>
            <div class="flex gap-4">
                <button onclick="showAuth()" class="text-slate-600 dark:text-slate-300 font-medium hover:text-blue-600">Log In</button>
                <button onclick="showAuth()" class="bg-blue-600 text-white px-5 py-2 rounded-full font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-500/30">Get Started</button>
            </div>
        </nav>
        <header class="flex-1 flex flex-col items-center justify-center text-center px-4 animate-fade-in mt-10 md:mt-20 mb-20">
            <div class="inline-block px-4 py-1.5 mb-6 rounded-full bg-blue-50 dark:bg-slate-800 text-blue-600 dark:text-blue-400 text-sm font-bold tracking-wide uppercase">New: Global Rankings & Docs</div>
            <h1 class="text-5xl md:text-7xl font-extrabold text-slate-900 dark:text-white mb-6 leading-tight">Master Your Workflow.<br><span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600">Achieve Greatness.</span></h1>
            <p class="text-lg md:text-xl text-slate-500 dark:text-slate-400 max-w-2xl mb-10">Taska combines Project Management, Real-time Chat, Documentation, and Gamified Rankings into one powerful platform.</p>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-12 text-left max-w-4xl w-full">
                <div class="p-4 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-100 dark:border-slate-700"><i class="ph ph-kanban text-2xl text-blue-500 mb-2"></i><h3 class="font-bold">Kanban & Tables</h3><p class="text-xs text-slate-500">Visualize work your way.</p></div>
                <div class="p-4 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-100 dark:border-slate-700"><i class="ph ph-trophy text-2xl text-yellow-500 mb-2"></i><h3 class="font-bold">Global Rankings</h3><p class="text-xs text-slate-500">Compete & earn titles.</p></div>
                <div class="p-4 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-100 dark:border-slate-700"><i class="ph ph-file-text text-2xl text-green-500 mb-2"></i><h3 class="font-bold">Docs & Notes</h3><p class="text-xs text-slate-500">Keep knowledge central.</p></div>
                <div class="p-4 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-100 dark:border-slate-700"><i class="ph ph-chart-pie-slice text-2xl text-purple-500 mb-2"></i><h3 class="font-bold">Smart Dashboard</h3><p class="text-xs text-slate-500">Track your brilliance.</p></div>
            </div>

            <button onclick="showAuth()" class="bg-slate-900 dark:bg-white dark:text-slate-900 text-white px-8 py-4 rounded-xl font-bold text-lg hover:scale-105 transition shadow-xl">Start for Free</button>
        </header>
    </div>

    <div id="auth-screen" class="hidden-section fixed inset-0 z-[90] bg-white dark:bg-slate-900 flex items-center justify-center p-4">
        <div class="w-full max-w-md text-center">
            <button onclick="hideAuth()" class="absolute top-6 left-6 text-slate-400 hover:text-slate-600 flex items-center gap-2"><i class="ph ph-arrow-left"></i> Back</button>
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-blue-600 text-white mb-6 shadow-xl shadow-blue-500/20"><img src="taska-logo-226.png" class="w-10 h-10 object-contain"></div>
            <h1 class="text-3xl font-bold text-slate-900 dark:text-white mb-8">Welcome Back</h1>
            <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700">
                <button id="google-signin" class="w-full bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-white font-medium py-3 rounded-xl flex items-center justify-center gap-3 hover:bg-slate-50 transition mb-6"><i class="ph ph-google-logo text-xl text-red-500"></i> Continue with Google</button>
                <div class="relative my-6"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-100 dark:border-slate-600"></div></div><div class="relative flex justify-center text-xs text-slate-400 bg-white dark:bg-slate-800 px-2">OR EMAIL</div></div>
                <form id="login-form" class="space-y-4">
                    <input type="email" id="login-email" placeholder="Email" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-900 dark:text-white rounded-xl outline-none border border-transparent focus:border-blue-500">
                    <input type="password" id="login-pass" placeholder="Password" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-900 dark:text-white rounded-xl outline-none border border-transparent focus:border-blue-500">
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition">Sign In</button>
                </form>
                <p class="mt-6 text-sm text-slate-500"><button onclick="toggleAuthMode()" class="text-blue-600 font-bold hover:underline">Create Account</button></p>
                <form id="signup-form" class="space-y-4 hidden-section mt-4 pt-4 border-t border-slate-100 dark:border-slate-700">
                    <input type="text" id="signup-name" placeholder="Name" required class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-900 dark:text-white rounded-xl outline-none">
                    <input type="email" id="signup-email" placeholder="Email" required class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-900 dark:text-white rounded-xl outline-none">
                    <input type="password" id="signup-pass" placeholder="Password" required class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-900 dark:text-white rounded-xl outline-none">
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700">Join Taska</button>
                </form>
            </div>
        </div>
    </div>

    <div id="main-app" class="flex h-full hidden-section relative overflow-hidden">
        <div id="mobile-overlay" class="mobile-overlay md:hidden" onclick="toggleSidebar()"></div>

        <aside id="sidebar" class="w-72 bg-white dark:bg-slate-850 border-r border-slate-200 dark:border-slate-800 flex flex-col flex-shrink-0 z-50 fixed md:static h-full -ml-72 md:ml-0">
            <div class="h-16 flex items-center justify-between px-6 border-b border-slate-100 dark:border-slate-800">
                <div class="flex items-center gap-3">
                    <img src="taska-logo-226.png" class="w-8 h-8 object-contain">
                    <span class="font-bold text-xl tracking-tight dark:text-white">Taska</span>
                </div>
                <button onclick="toggleSidebar()" class="md:hidden p-2 text-slate-400 hover:text-red-500 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"><i class="ph ph-x text-xl"></i></button>
            </div>
            <div class="p-4 border-b border-slate-100 dark:border-slate-800">
                <div class="flex items-center gap-3 p-2 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 cursor-pointer transition mb-4" onclick="openModal('profile-modal')">
                    <img id="sidebar-avatar-img" src="" class="w-10 h-10 rounded-full object-cover hidden">
                    <div id="sidebar-avatar-initial" class="w-10 h-10 rounded-full bg-gradient-to-tr from-blue-500 to-indigo-500 text-white flex items-center justify-center font-bold text-lg shadow-sm">U</div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-bold text-slate-900 dark:text-white truncate" id="sidebar-name">User</p>
                        <p class="text-xs text-slate-500 truncate font-mono" id="sidebar-username">@user</p>
                    </div>
                </div>
                <div class="bg-slate-50 dark:bg-slate-800 p-3 rounded-lg">
                    <div class="flex justify-between text-xs font-bold text-slate-500 mb-1"><span>Current Rank</span><span id="rank-title" class="text-blue-600">Novice</span></div>
                    <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2"><div id="rank-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                </div>
            </div>
            <nav class="flex-1 overflow-y-auto px-4 py-4 space-y-1">
                <button onclick="switchView('dashboard')" id="nav-dashboard" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition"><i class="ph ph-gauge text-lg"></i> Dashboard</button>
                <button onclick="switchView('myday')" id="nav-myday" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition"><i class="ph ph-sun text-lg"></i> My Day</button>
                <button onclick="switchView('important')" id="nav-important" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition"><i class="ph ph-star text-lg"></i> Important</button>
                <button onclick="switchView('all')" id="nav-all" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition"><i class="ph ph-infinity text-lg"></i> All Tasks</button>
                <button onclick="switchView('table')" id="nav-table" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition"><i class="ph ph-table text-lg"></i> Table View</button>
                <button onclick="switchView('calendar')" id="nav-calendar" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition"><i class="ph ph-calendar text-lg"></i> Calendar</button>
                <button onclick="switchView('board')" id="nav-board" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition"><i class="ph ph-kanban text-lg"></i> Board View</button>
                <button onclick="switchView('docs')" id="nav-docs" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition"><i class="ph ph-file-text text-lg"></i> Docs</button>
                <button onclick="switchView('ranking')" id="nav-ranking" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg text-slate-600 dark:text-slate-300 hover:bg-yellow-50 hover:text-yellow-600 dark:hover:bg-yellow-900/20 transition"><i class="ph ph-trophy text-lg"></i> Rankings</button>
                <button onclick="switchView('bin')" id="nav-bin" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg text-slate-600 dark:text-slate-300 hover:bg-red-50 hover:text-red-600 dark:hover:bg-red-900/20 transition"><i class="ph ph-trash text-lg"></i> Recycle Bin</button>
                <div class="mt-8 mb-2 px-3 flex items-center justify-between text-xs font-bold text-slate-400 uppercase tracking-wider"><span>Projects</span><button onclick="openModal('project-modal')" class="hover:text-blue-600 text-lg transition"><i class="ph ph-plus-circle"></i></button></div>
                <div id="project-list-sidebar" class="space-y-1"></div>
            </nav>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 bg-white dark:bg-slate-900 relative transition-colors">
            <header id="header-area" class="h-16 flex items-center justify-between px-6 border-b border-slate-100 dark:border-slate-800 bg-white/80 dark:bg-slate-900/80 backdrop-blur z-20 sticky top-0">
                <div class="flex items-center gap-4">
                    <button class="text-slate-500 hover:text-blue-600 transition p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 md:hidden" onclick="toggleSidebar()"><i class="ph ph-list text-2xl"></i></button>
                    <div><h2 class="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2" id="header-title">Dashboard</h2><p class="text-xs text-slate-500 truncate max-w-[200px]" id="header-subtitle">Overview</p></div>
                </div>
                <div class="flex gap-2 items-center">
                    <select id="sort-select" onchange="updateSort(this.value)" class="text-xs bg-transparent text-slate-500 border border-slate-200 dark:border-slate-700 rounded px-2 py-1 outline-none hidden md:block">
                        <option value="date_desc">Newest First</option>
                        <option value="priority">Priority</option>
                        <option value="alpha">A-Z</option>
                    </select>
                    <button onclick="openStopwatch()" class="p-2 text-slate-500 hover:text-indigo-600 bg-indigo-50 dark:bg-indigo-900/30 dark:text-indigo-300 rounded-lg flex items-center gap-2 text-sm font-bold ml-2" title="Focus Mode"><i class="ph ph-clock-countdown text-xl"></i></button>
                    <div id="project-actions" class="hidden-section flex gap-2 mx-2 border-r border-slate-200 dark:border-slate-700 pr-4">
                        <button onclick="toggleChat()" class="p-2 text-slate-500 hover:text-blue-600 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg flex items-center gap-2 text-sm font-bold relative"><i class="ph ph-chat-circle-text text-xl"></i></button>
                    </div>
                    <button onclick="toggleDarkMode()" class="p-2 text-slate-400 hover:text-blue-500 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800"><i class="ph ph-moon text-xl dark:hidden"></i><i class="ph ph-sun text-xl hidden dark:block"></i></button>
                    <button onclick="window.print()" class="p-2 text-slate-400 hover:text-blue-500 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 hidden md:block" title="Print View"><i class="ph ph-printer text-xl"></i></button>
                </div>
            </header>

            <div id="view-dashboard" class="flex-1 overflow-y-auto p-6 md:p-10 bg-slate-50 dark:bg-slate-850 hidden-section">
                <h2 class="text-2xl font-bold dark:text-white mb-2">Performance Dashboard</h2>
                <div id="dashboard-message" class="text-lg font-medium text-blue-600 mb-8">Loading stats...</div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700"><div class="flex justify-between"><span class="text-slate-500">Tasks Completed</span><i class="ph ph-check-circle text-green-500 text-xl"></i></div><h3 id="dash-completed" class="text-3xl font-bold dark:text-white mt-2">0</h3></div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700"><div class="flex justify-between"><span class="text-slate-500">Pending</span><i class="ph ph-clock text-orange-500 text-xl"></i></div><h3 id="dash-pending" class="text-3xl font-bold dark:text-white mt-2">0</h3></div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700"><div class="flex justify-between"><span class="text-slate-500">Current Rank</span><i class="ph ph-trophy text-yellow-500 text-xl"></i></div><h3 id="dash-rank" class="text-3xl font-bold dark:text-white mt-2">-</h3></div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                    <h3 class="font-bold mb-4 dark:text-white">Completion Trend</h3>
                    <div class="h-64 flex items-center justify-center text-slate-400">Chart Visualization Ready</div>
                </div>
            </div>

            <div id="view-ranking" class="flex-1 overflow-y-auto p-6 bg-slate-50 dark:bg-slate-850 hidden-section">
                <div class="max-w-3xl mx-auto">
                    <div class="text-center mb-10">
                        <h2 class="text-3xl font-bold dark:text-white mb-2">Global Leaderboard</h2>
                        <p class="text-slate-500">Compete with the community. Earn 10 XP per task.</p>
                    </div>
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl overflow-hidden border border-slate-100 dark:border-slate-700">
                        <div class="grid grid-cols-12 bg-slate-50 dark:bg-slate-900 p-4 text-xs font-bold text-slate-500 uppercase tracking-wider">
                            <div class="col-span-1 text-center">Rank</div>
                            <div class="col-span-6">User</div>
                            <div class="col-span-3 text-right">Title</div>
                            <div class="col-span-2 text-right">XP</div>
                        </div>
                        <div id="ranking-list" class="divide-y divide-slate-100 dark:divide-slate-700"></div>
                    </div>
                </div>
            </div>
            
            <div id="view-docs" class="flex-1 overflow-y-auto p-6 hidden-section bg-slate-50 dark:bg-slate-850">
                <div class="flex justify-between mb-4">
                    <h2 class="text-xl font-bold dark:text-white">Documents</h2>
                    <button onclick="createNewDoc()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold">New Doc</button>
                </div>
                <div id="docs-list" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8"></div>
                <div id="doc-editor" class="hidden-section bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg h-[70vh] flex flex-col">
                    <input type="text" id="doc-title" class="text-2xl font-bold mb-4 outline-none bg-transparent dark:text-white" placeholder="Document Title">
                    <textarea id="doc-content" class="flex-1 resize-none outline-none bg-transparent dark:text-slate-300" placeholder="Start typing..."></textarea>
                    <div class="flex justify-end gap-2 mt-4">
                        <button onclick="closeDoc()" class="text-slate-500 hover:text-slate-700">Close</button>
                        <button onclick="saveDoc()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold">Save</button>
                    </div>
                </div>
            </div>

            <div id="view-table" class="flex-1 overflow-y-auto p-6 hidden-section bg-white dark:bg-slate-900">
                 <table class="w-full text-left border-collapse">
                     <thead>
                         <tr class="border-b border-slate-200 dark:border-slate-700 text-xs font-bold text-slate-500 uppercase">
                             <th class="py-3 pl-2"><input type="checkbox" onchange="toggleSelectAll(this)"></th>
                             <th class="py-3">Task Name</th>
                             <th class="py-3">Assignee</th>
                             <th class="py-3">Due Date</th>
                             <th class="py-3">Priority</th>
                             <th class="py-3">Status</th>
                         </tr>
                     </thead>
                     <tbody id="table-body" class="text-sm text-slate-700 dark:text-slate-300 divide-y divide-slate-100 dark:divide-slate-800"></tbody>
                 </table>
                 <div id="bulk-actions" class="hidden-section fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-4 z-40">
                     <span id="selected-count" class="font-bold">0 Selected</span>
                     <button onclick="bulkDelete()" class="text-red-400 hover:text-white font-bold">Delete</button>
                     <button onclick="bulkComplete()" class="text-green-400 hover:text-white font-bold">Mark Done</button>
                 </div>
            </div>

            <div id="view-list" class="flex-1 overflow-y-auto p-6 md:p-10 relative">
                <div id="project-description-area" class="hidden-section mb-6 bg-blue-50 dark:bg-slate-800/50 p-4 rounded-xl border border-blue-100 dark:border-slate-700 text-sm text-slate-600 dark:text-slate-300"></div>
                <div class="hidden md:flex flex-col mb-8 no-print">
                    <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-sm rounded-xl p-2 flex items-center gap-3 focus-within:ring-2 focus-within:ring-blue-100 dark:focus-within:ring-blue-900 focus-within:border-blue-400 transition-all">
                        <i class="ph ph-plus text-xl text-slate-300 ml-3"></i>
                        <input type="text" id="quick-add-input" placeholder="Add a new task..." class="flex-1 bg-transparent outline-none text-slate-700 dark:text-slate-200 placeholder-slate-400 h-10" onkeydown="handleQuickAdd(event)">
                        <div class="flex items-center gap-2 border-l border-slate-100 dark:border-slate-700 pl-3">
                             <input type="date" id="quick-add-date" class="bg-transparent text-xs text-slate-500 outline-none w-28 dark:text-slate-400">
                             <select id="quick-add-priority" class="bg-transparent text-xs text-slate-500 outline-none w-20 dark:text-slate-400 dark:bg-slate-800"><option value="Low">Low</option><option value="Medium" selected>Medium</option><option value="High">High</option><option value="Critical">Critical</option></select>
                             <button class="p-2 rounded hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-400 transition" onclick="this.classList.toggle('text-yellow-500')" id="quick-add-star"><i class="ph ph-star-fill text-lg"></i></button>
                        </div>
                        <button class="px-4 py-2 bg-blue-600 text-white text-sm font-bold rounded-lg hover:bg-blue-700 transition" onclick="triggerQuickAdd()">Add Task</button>
                        <button onclick="openModal('bulk-add-modal')" class="px-3 py-2 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-slate-200 text-xs font-bold" title="Bulk Add from AI List">Bulk</button>
                    </div>
                    <div id="quick-project-chips" class="flex gap-2 mt-2 px-2 overflow-x-auto pb-1"></div>
                </div>
                <div id="task-list-container" class="space-y-2 pb-24"></div>
            </div>
            
            <button id="mobile-fab" onclick="openAddModal()" class="fixed bottom-8 right-8 w-14 h-14 bg-blue-600 text-white rounded-full shadow-lg shadow-blue-500/40 flex items-center justify-center text-3xl hover:scale-110 active:scale-95 transition z-[60] md:hidden"><i class="ph ph-plus"></i></button>

            <div id="view-board" class="flex-1 overflow-x-auto overflow-y-hidden p-6 hidden-section bg-slate-50 dark:bg-slate-850">
                <div class="flex gap-6 h-full">
                    <div class="board-column flex flex-col h-full w-80 min-w-[300px]"><div class="flex justify-between mb-4"><h3 class="font-bold dark:text-white">To Do</h3></div><div class="flex-1 overflow-y-auto space-y-3" id="board-todo"></div></div>
                    <div class="board-column flex flex-col h-full w-80 min-w-[300px]"><div class="flex justify-between mb-4"><h3 class="font-bold text-blue-500">In Progress</h3></div><div class="flex-1 overflow-y-auto space-y-3" id="board-progress"></div></div>
                    <div class="board-column flex flex-col h-full w-80 min-w-[300px]"><div class="flex justify-between mb-4"><h3 class="font-bold text-green-500">Done</h3></div><div class="flex-1 overflow-y-auto space-y-3" id="board-done"></div></div>
                </div>
            </div>
            <div id="view-calendar" class="flex-1 overflow-y-auto p-6 hidden-section bg-slate-50 dark:bg-slate-850">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-lg font-bold dark:text-white" id="calendar-month-year"></h2>
                    <div class="flex gap-2">
                        <button onclick="changeMonth(-1)" class="p-2 hover:bg-slate-200 dark:hover:bg-slate-700 rounded"><i class="ph ph-caret-left"></i></button>
                        <button onclick="changeMonth(1)" class="p-2 hover:bg-slate-200 dark:hover:bg-slate-700 rounded"><i class="ph ph-caret-right"></i></button>
                    </div>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center font-bold text-slate-400 mb-2"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>
                <div id="calendar-grid" class="calendar-grid border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden"></div>
            </div>
            <div id="view-bin" class="flex-1 overflow-y-auto p-6 hidden-section bg-slate-50 dark:bg-slate-850">
                <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold dark:text-white">Recycle Bin</h2><button onclick="emptyBin()" class="text-red-500 text-sm hover:underline">Empty Bin</button></div>
                <div id="bin-list" class="space-y-2"></div>
            </div>
            
            <aside id="chat-panel" class="fixed top-16 right-0 w-80 h-[calc(100%-4rem)] bg-white dark:bg-slate-850 border-l border-slate-200 dark:border-slate-800 shadow-xl transform translate-x-full z-30 flex flex-col">
                 <div class="p-4 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-900"><h3 class="font-bold dark:text-white">Project Chat</h3><button onclick="toggleChat()" class="text-slate-400 hover:text-red-500"><i class="ph ph-x"></i></button></div>
                 <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50 dark:bg-slate-900"></div>
                 <div class="p-3 border-t border-slate-100 dark:border-slate-800 bg-white dark:bg-slate-850">
                     <div class="flex gap-2 items-center">
                         <input type="text" id="chat-input" placeholder="Type..." class="flex-1 bg-slate-100 dark:bg-slate-800 border-none rounded-full px-4 py-2 text-sm outline-none dark:text-white" onkeydown="if(event.key==='Enter') sendChat()">
                         <button onclick="sendChat()" class="text-blue-600 hover:text-blue-700"><i class="ph ph-paper-plane-right text-xl"></i></button>
                     </div>
                 </div>
            </aside>
        </main>

        <aside id="detail-panel" class="w-96 bg-white dark:bg-slate-850 border-l border-slate-200 dark:border-slate-800 hidden lg:flex flex-col shadow-2xl z-50 transition-transform">
             <div class="h-16 flex items-center justify-between px-6 border-b border-slate-100 dark:border-slate-800"><span class="font-bold text-sm text-slate-400 uppercase">Edit Task</span><button onclick="closeDetail()" class="text-slate-400 hover:text-slate-600 dark:hover:text-white p-2"><i class="ph ph-x text-xl"></i></button></div>
            <div id="active-detail" class="flex-col h-full hidden-section">
                <div class="p-6 border-b border-slate-100 dark:border-slate-800"><div class="flex items-start gap-4"><button onclick="toggleDetailComplete()" id="detail-check" class="mt-1 w-6 h-6 rounded-full border-2 flex items-center justify-center transition text-white"><i class="ph ph-check text-xs"></i></button><textarea id="detail-title" rows="2" class="flex-1 text-lg font-bold text-slate-800 dark:text-white bg-transparent outline-none resize-none" placeholder="Task Title"></textarea><button onclick="toggleDetailStar()" id="detail-star" class="text-2xl"><i class="ph ph-star-fill"></i></button></div></div>
                <div class="flex-1 overflow-y-auto p-6 space-y-6">
                    <div><div id="steps-list" class="space-y-2 mb-2"></div><button class="text-blue-600 text-sm font-medium flex items-center gap-2 hover:bg-slate-50 dark:hover:bg-slate-800 p-2 rounded w-full transition" onclick="addStep()"><i class="ph ph-plus"></i> Add step</button></div>
                    <div class="space-y-4 pt-4 border-t border-slate-100 dark:border-slate-800">
                         <div class="flex items-center gap-3"><i class="ph ph-calendar text-xl text-slate-400"></i><input type="date" id="detail-due" class="bg-transparent outline-none text-sm text-slate-600 dark:text-slate-300 w-full" onchange="updateTaskDetail('dueDate', this.value)"></div>
                         <div class="flex items-center gap-3"><i class="ph ph-bell text-xl text-slate-400"></i><input type="datetime-local" id="detail-reminder" class="bg-transparent outline-none text-sm text-slate-600 dark:text-slate-300 w-full" onchange="updateTaskDetail('reminder', this.value)" title="Set Reminder"></div>
                         <div class="flex items-center gap-3"><i class="ph ph-flag text-xl text-slate-400"></i><select id="detail-priority" class="bg-transparent outline-none text-sm text-slate-600 dark:text-slate-300 w-full dark:bg-slate-850" onchange="updateTaskDetail('priority', this.value)"><option value="Low">Low</option><option value="Medium">Medium</option><option value="High">High</option><option value="Critical">Critical</option></select></div>
                         <div class="flex items-center gap-3"><i class="ph ph-user text-xl text-slate-400"></i><input type="text" id="detail-assignee" placeholder="Assignee (email)" class="bg-transparent outline-none text-sm text-slate-600 dark:text-slate-300 w-full" onchange="updateTaskDetail('assignee', this.value)"></div>
                    </div>
                    <textarea id="detail-notes" class="w-full h-32 bg-slate-50 dark:bg-slate-800 rounded-xl p-4 text-sm resize-y outline-none text-slate-700 dark:text-slate-300 border-none" placeholder="Add notes..." onchange="updateTaskDetail('remarks', this.value)"></textarea>
                </div>
                <div class="p-4 border-t border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-900 flex justify-end"><button onclick="softDeleteTask()" class="text-red-500 hover:text-red-700 text-sm font-medium flex items-center gap-2"><i class="ph ph-trash"></i> Move to Bin</button></div>
            </div>
        </aside>

        <div id="add-modal" class="hidden-section fixed inset-0 bg-black/50 z-[100] flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm"><div class="bg-white dark:bg-slate-800 w-full sm:max-w-lg rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl animate-slide-up"><div class="flex justify-between mb-4"><h3 class="font-bold text-lg dark:text-white">New Task</h3><button onclick="closeModal('add-modal')" class="text-slate-400"><i class="ph ph-x text-xl"></i></button></div><input type="text" id="modal-add-title" placeholder="What needs to be done?" class="w-full text-lg bg-transparent outline-none border-b border-slate-200 dark:border-slate-700 pb-2 mb-6 dark:text-white" onkeydown="if(event.key==='Enter') triggerModalAdd()"><div class="grid grid-cols-2 gap-4 mb-6"><div><label class="text-xs text-slate-400 font-bold uppercase block mb-1">Due Date</label><input type="date" id="modal-add-date" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm dark:text-white"></div><div><label class="text-xs text-slate-400 font-bold uppercase block mb-1">Priority</label><select id="modal-add-priority" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm dark:text-white"><option value="Low">Low</option><option value="Medium" selected>Medium</option><option value="High">High</option><option value="Critical">Critical</option></select></div><div class="col-span-2"><label class="text-xs text-slate-400 font-bold uppercase block mb-1">Project</label><select id="modal-add-project" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm dark:text-white"><option value="">No Project</option></select></div></div><div class="flex justify-end gap-3"><button onclick="triggerModalAdd()" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold w-full sm:w-auto">Save Task</button></div></div></div>
        
        <div id="bulk-add-modal" class="hidden-section fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white dark:bg-slate-800 w-full max-w-lg rounded-2xl p-6 shadow-2xl"><div class="flex justify-between mb-4"><h3 class="font-bold text-lg dark:text-white">Bulk Add Tasks</h3><button onclick="closeModal('bulk-add-modal')" class="text-slate-400"><i class="ph ph-x text-xl"></i></button></div><p class="text-sm text-slate-500 mb-2">Paste a list of tasks (one per line).</p><textarea id="bulk-text" rows="8" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-3 text-sm dark:text-white outline-none mb-4" placeholder="Task 1&#10;Task 2"></textarea><div class="flex justify-between items-center"><select id="bulk-project" class="bg-slate-100 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm dark:text-white"><option value="">No Project</option></select><button onclick="processBulkAdd()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold">Add All</button></div></div></div>

        <div id="stopwatch-modal" class="hidden-section fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white dark:bg-slate-800 w-full max-w-sm rounded-3xl p-8 shadow-2xl text-center"><div class="flex justify-end"><button onclick="closeModal('stopwatch-modal')" class="text-slate-400 hover:text-white"><i class="ph ph-x text-xl"></i></button></div><div class="mb-6"><div class="text-6xl font-mono font-bold text-slate-800 dark:text-white tracking-widest mb-2" id="timer-display">30:00</div><p class="text-sm text-slate-500 font-medium uppercase tracking-wide">Focus Session</p></div><div class="flex justify-center gap-4 mb-8"><button onclick="toggleTimer()" id="btn-timer-toggle" class="w-16 h-16 rounded-full bg-blue-600 hover:bg-blue-700 text-white flex items-center justify-center text-3xl shadow-lg transition transform hover:scale-105"><i class="ph ph-play-fill" id="icon-timer"></i></button><button onclick="resetTimer()" class="w-16 h-16 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-white flex items-center justify-center text-3xl hover:bg-slate-200 transition"><i class="ph ph-arrow-counter-clockwise"></i></button></div><button onclick="extendTimer(10)" class="text-sm text-blue-600 dark:text-blue-400 font-bold hover:underline">+ Extend 10 Minutes</button></div></div>

        <div id="project-modal" class="hidden-section fixed inset-0 bg-black/40 z-[100] flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-sm p-6 shadow-2xl"><h3 class="text-lg font-bold mb-4 dark:text-white">New Project</h3><form id="project-form" class="space-y-4"><input type="text" id="proj-name" placeholder="Project Name" required class="w-full border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 dark:text-white rounded-lg px-3 py-2 outline-none focus:border-blue-500"><textarea id="proj-desc" placeholder="Description (Optional)" class="w-full border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 dark:text-white rounded-lg px-3 py-2 outline-none focus:border-blue-500"></textarea><div class="flex items-center justify-between dark:text-slate-300"><label class="text-sm">Color</label><input type="color" id="proj-color" value="#3b82f6" class="w-8 h-8 rounded-full border-0 p-0 cursor-pointer"></div><div class="flex gap-2 pt-2"><button type="button" onclick="closeModal('project-modal')" class="flex-1 py-2 text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg">Cancel</button><button type="submit" class="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Create</button></div></form></div></div>
        
        <div id="profile-modal" class="hidden-section fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-lg p-8 shadow-2xl relative"><button onclick="closeModal('profile-modal')" class="absolute top-6 right-6 text-slate-400 hover:text-slate-600 dark:hover:text-white"><i class="ph ph-x text-xl"></i></button><h2 class="text-2xl font-bold mb-6 dark:text-white">Edit Profile</h2><div class="flex flex-col items-center mb-8"><div class="w-24 h-24 rounded-full bg-slate-200 overflow-hidden mb-3 shadow-lg relative cursor-pointer" onclick="document.getElementById('avatar-upload').click()"><img id="edit-avatar-img" class="w-full h-full object-cover hidden"><div id="edit-avatar-placeholder" class="w-full h-full flex items-center justify-center text-4xl font-bold text-slate-500">U</div><div class="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 hover:opacity-100 transition"><i class="ph ph-camera text-white text-2xl"></i></div></div><input type="file" id="avatar-upload" class="hidden" accept="image/*" onchange="handleAvatarUpload(this)"><p class="text-xs text-slate-400">Max 100KB</p></div><form id="profile-form" class="space-y-4"><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Display Name</label><input type="text" id="edit-name" class="w-full border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 dark:text-white rounded-xl px-4 py-3 outline-none"></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Username</label><div class="flex gap-2"><input type="text" id="edit-username" class="flex-1 border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 dark:text-white rounded-xl px-4 py-3 outline-none" placeholder="username"><button type="button" onclick="checkUsername()" class="px-3 bg-blue-50 text-blue-600 rounded-xl text-sm font-bold">Check</button></div><p id="username-msg" class="text-xs mt-1"></p></div><div class="flex gap-2"><button type="button" onclick="exportTasksCSV()" class="flex-1 bg-green-50 text-green-600 border border-green-200 py-2 rounded-xl text-sm font-bold hover:bg-green-100">Export CSV</button><button type="button" onclick="document.getElementById('import-file').click()" class="flex-1 bg-blue-50 text-blue-600 border border-blue-200 py-2 rounded-xl text-sm font-bold hover:bg-blue-100">Import CSV</button><input type="file" id="import-file" class="hidden" accept=".csv" onchange="importTasksCSV(this)"></div><button type="submit" class="w-full bg-slate-900 dark:bg-blue-600 text-white font-bold py-3.5 rounded-xl hover:opacity-90 transition">Save Changes</button><button type="button" onclick="handleLogout()" class="w-full border border-red-200 text-red-500 font-bold py-3 rounded-xl hover:bg-red-50 dark:border-red-900/50 dark:hover:bg-red-900/20 transition">Sign Out</button></form></div></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, orderBy, serverTimestamp, updateDoc, doc, deleteDoc, getDoc, setDoc, arrayUnion, arrayRemove, enableMultiTabIndexedDbPersistence, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDcA7kVuRrK9194a7rDSvPM0PgaLHSLkIk",
            authDomain: "khb-todo.firebaseapp.com",
            projectId: "khb-todo",
            storageBucket: "khb-todo.firebasestorage.app",
            messagingSenderId: "1048671093982",
            appId: "1:1048671093982:web:8cbc4db58f5fe7ec21ae4f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        try { enableMultiTabIndexedDbPersistence(db); } catch(err) { console.log("Persistence error:", err); }

        let currentUser = null, tasks = [], projects = [], currentView = 'dashboard', selectedTaskId = null, editingProjectId = null, selectedIds = new Set();
        let currentSort = 'date_desc';
        let timerInterval = null, timerSeconds = 1800;

        // Auth
        onAuthStateChanged(auth, async (user) => {
            document.getElementById('loading-overlay').classList.add('hidden-section');
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').classList.add('hidden-section');
                document.getElementById('landing-page').classList.add('hidden-section');
                document.getElementById('main-app').classList.remove('hidden-section');
                loadUserProfile();
                subscribeData();
                setInterval(checkReminders, 60000);
            } else {
                currentUser = null;
                document.getElementById('main-app').classList.add('hidden-section');
                document.getElementById('auth-screen').classList.add('hidden-section');
                document.getElementById('landing-page').classList.remove('hidden-section');
            }
        });

        async function loadUserProfile() {
             const snap = await getDoc(doc(db, "userProfiles", currentUser.uid));
             let data = snap.exists() ? snap.data() : {};
             if(!data.username) {
                  const r = Math.floor(Math.random()*10000);
                  data = { username: `user${r}`, displayName: currentUser.displayName, avatar: null, totalXP: 0, title: 'Novice' };
                  await setDoc(doc(db, "userProfiles", currentUser.uid), data, {merge:true});
             }
             document.getElementById('sidebar-name').textContent = data.displayName || 'User';
             document.getElementById('sidebar-username').textContent = '@' + data.username;
             document.getElementById('rank-title').textContent = data.title || 'Novice';
             if(data.avatar) {
                 document.getElementById('sidebar-avatar-img').src = data.avatar;
                 document.getElementById('sidebar-avatar-img').classList.remove('hidden');
                 document.getElementById('sidebar-avatar-initial').classList.add('hidden');
             }
             // Calculate Rank Progress (simple logic: each level 100 XP)
             const xp = data.totalXP || 0;
             const progress = (xp % 100);
             document.getElementById('rank-progress-bar').style.width = `${progress}%`;
        }

        function subscribeData() {
            onSnapshot(query(collection(db, "projects"), where("userId", "==", currentUser.uid), orderBy("createdAt", "desc")), (s) => handleProjectUpdate(s.docs.map(d => ({id: d.id, ...d.data()})), 'own'));
            onSnapshot(query(collection(db, "tasks"), where("userId", "==", currentUser.uid), orderBy("createdAt", "desc")), (s) => handleTaskUpdate(s.docs.map(d => ({id: d.id, ...d.data()})), 'mine'));
            // Docs subscription
            onSnapshot(query(collection(db, "docs"), where("userId", "==", currentUser.uid)), (s) => renderDocs(s.docs.map(d => ({id: d.id, ...d.data()}))));
        }

        function handleProjectUpdate(data) { projects = data; renderSidebarProjects(); renderModalSelect(); refreshView(); }
        function handleTaskUpdate(data) { tasks = data; refreshView(); updateDashboard(); }

        // Core View Logic
        window.switchView = (v) => { currentView = v; selectedTaskId = null; closeDetail(); refreshView(); if(window.innerWidth < 768) toggleSidebar(); };
        window.refreshView = () => {
            const list = document.getElementById('task-list-container');
            const hTitle = document.getElementById('header-title');
            const activeTasks = tasks.filter(t => !t.deletedAt);
            let filtered = [];
            
            // Hide all views first
            ['view-list', 'view-board', 'view-calendar', 'view-bin', 'view-dashboard', 'view-ranking', 'view-docs', 'view-table'].forEach(id => document.getElementById(id).classList.add('hidden-section'));
            document.getElementById('project-actions').classList.add('hidden-section');
            document.getElementById('sort-select').classList.remove('hidden');

            // Header Logic
            if(currentView === 'dashboard') {
                hTitle.textContent = "Dashboard";
                document.getElementById('view-dashboard').classList.remove('hidden-section');
                document.getElementById('sort-select').classList.add('hidden');
                updateDashboard();
                return;
            }
            if(currentView === 'ranking') {
                hTitle.textContent = "Rankings";
                document.getElementById('view-ranking').classList.remove('hidden-section');
                loadRankings();
                return;
            }
            if(currentView === 'docs') {
                hTitle.textContent = "Documents";
                document.getElementById('view-docs').classList.remove('hidden-section');
                return;
            }
            if(currentView === 'bin') {
                hTitle.textContent = "Recycle Bin";
                document.getElementById('view-bin').classList.remove('hidden-section');
                renderBin();
                return;
            }

            // Task Filtering
            if(currentView === 'myday') { filtered = activeTasks.filter(t => t.isMyDay || t.dueDate === new Date().toISOString().split('T')[0]); hTitle.textContent = "My Day"; }
            else if(currentView === 'all' || currentView === 'table') { filtered = activeTasks; hTitle.textContent = "All Tasks"; }
            else if(currentView === 'important') { filtered = activeTasks.filter(t => t.isImportant); hTitle.textContent = "Important"; }
            else { 
                const p = projects.find(x => x.id === currentView);
                if(p) { filtered = activeTasks.filter(t => t.projectId === currentView); hTitle.textContent = p.name; document.getElementById('project-actions').classList.remove('hidden-section'); }
                else { filtered = activeTasks; } // Fallback
            }

            // Sorting
            filtered.sort((a,b) => {
                if(currentSort === 'date_desc') return (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0);
                if(currentSort === 'priority') { const map={'Critical':3,'High':2,'Medium':1,'Low':0}; return map[b.priority]-map[a.priority]; }
                if(currentSort === 'alpha') return a.title.localeCompare(b.title);
                return 0;
            });

            // Render specific task views
            if(currentView === 'board') { document.getElementById('view-board').classList.remove('hidden-section'); renderBoard(filtered); }
            else if(currentView === 'calendar') { document.getElementById('view-calendar').classList.remove('hidden-section'); renderCalendar(filtered); }
            else if(currentView === 'table') { document.getElementById('view-table').classList.remove('hidden-section'); renderTable(filtered); }
            else { 
                document.getElementById('view-list').classList.remove('hidden-section');
                list.innerHTML = filtered.length ? filtered.map(t => renderTaskRow(t)).join('') : '<div class="text-center text-slate-400 py-10">No tasks found</div>';
            }
            
            // Highlight Nav
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('bg-slate-100', 'dark:bg-slate-800', 'text-blue-600'));
            const btn = document.getElementById(`nav-${currentView}`) || document.getElementById(`nav-all`);
            if(btn) btn.classList.add('bg-slate-100', 'dark:bg-slate-800', 'text-blue-600');
        };

        // Dashboard Logic
        function updateDashboard() {
            const active = tasks.filter(t => !t.deletedAt);
            const done = active.filter(t => t.status === 'Done').length;
            const pending = active.length - done;
            const rate = active.length ? Math.round((done/active.length)*100) : 0;
            
            document.getElementById('dash-completed').textContent = done;
            document.getElementById('dash-pending').textContent = pending;
            
            let msg = "Keep going!";
            if(rate > 30) msg = "Good work!";
            if(rate > 60) msg = "Great job!";
            if(rate > 90) msg = "Brilliant performance!";
            document.getElementById('dashboard-message').textContent = `${msg} You've completed ${rate}% of your tasks.`;
            
            getDoc(doc(db, "userProfiles", currentUser.uid)).then(s => {
                if(s.exists()) document.getElementById('dash-rank').textContent = s.data().title || 'Novice';
            });
        }

        // Ranking Logic
        async function loadRankings() {
            const list = document.getElementById('ranking-list');
            list.innerHTML = '<div class="p-4 text-center">Loading rankings...</div>';
            // In production, limit this query. For demo, fetching all users.
            const snap = await getDoc(collection(db, "userProfiles")); // Wrong, use getDocs for collection
            // Correction:
            import { getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
            const q = query(collection(db, "userProfiles"), orderBy("totalXP", "desc"), limit(20)); // Need limit import
            // Simpler approach for this file without adding more imports:
            // I will assume global `getDocs` is available or import it.
            // Let's rely on a simpler mock or properly import getDocs.
        }
        // ... (Adding missing imports for Ranking)
        import { getDocs, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        window.loadRankings = async () => {
             const q = query(collection(db, "userProfiles"), orderBy("totalXP", "desc"), limit(20));
             const snap = await getDocs(q);
             let html = '';
             let rank = 1;
             snap.forEach(doc => {
                 const d = doc.data();
                 html += `<div class="grid grid-cols-12 p-4 items-center gap-2">
                     <div class="col-span-1 text-center font-bold text-blue-600">#${rank++}</div>
                     <div class="col-span-6 flex items-center gap-3">
                         <div class="w-8 h-8 rounded-full bg-slate-200 overflow-hidden">${d.avatar ? `<img src="${d.avatar}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center font-bold text-slate-500">${d.displayName[0]}</div>`}</div>
                         <div class="truncate text-sm font-medium dark:text-white">${d.displayName}</div>
                     </div>
                     <div class="col-span-3 text-right text-xs font-bold text-purple-500">${d.title||'Novice'}</div>
                     <div class="col-span-2 text-right text-sm font-mono dark:text-slate-300">${d.totalXP||0}</div>
                 </div>`;
             });
             document.getElementById('ranking-list').innerHTML = html;
        };

        // Profile & Username Logic
        window.handleAvatarUpload = (input) => {
            const file = input.files[0];
            if(!file) return;
            if(file.size > 100 * 1024) { alert("File too large. Max 100KB."); return; }
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64 = e.target.result;
                document.getElementById('edit-avatar-img').src = base64;
                document.getElementById('edit-avatar-img').classList.remove('hidden');
                document.getElementById('edit-avatar-placeholder').classList.add('hidden');
                await updateDoc(doc(db, "userProfiles", currentUser.uid), { avatar: base64 });
                loadUserProfile();
            };
            reader.readAsDataURL(file);
        };

        window.checkUsername = async () => {
             const val = document.getElementById('edit-username').value.trim();
             const msg = document.getElementById('username-msg');
             if(val.length < 3) { msg.textContent = "Too short"; msg.className = "text-xs mt-1 text-red-500"; return; }
             const q = query(collection(db, "userProfiles"), where("username", "==", val));
             const snap = await getDocs(q);
             if(!snap.empty && snap.docs[0].id !== currentUser.uid) {
                 msg.textContent = "Taken. Try: " + val + Math.floor(Math.random()*100);
                 msg.className = "text-xs mt-1 text-red-500";
             } else {
                 msg.textContent = "Available!";
                 msg.className = "text-xs mt-1 text-green-500";
             }
        };

        document.getElementById('profile-form').addEventListener('submit', async (e) => {
             e.preventDefault();
             const name = document.getElementById('edit-name').value;
             const username = document.getElementById('edit-username').value;
             await updateProfile(currentUser, { displayName: name });
             await updateDoc(doc(db, "userProfiles", currentUser.uid), { displayName: name, username: username });
             loadUserProfile();
             closeModal('profile-modal');
        });

        // Docs Logic
        window.renderDocs = (docs) => {
            const container = document.getElementById('docs-list');
            container.innerHTML = docs.map(d => `<div onclick="openDoc('${d.id}')" class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700 cursor-pointer hover:shadow-md h-32 flex flex-col justify-between"><h3 class="font-bold dark:text-white truncate">${d.title}</h3><p class="text-xs text-slate-400">Last edit: ${new Date(d.updatedAt?.seconds*1000).toLocaleDateString()}</p></div>`).join('');
        };
        let currentDocId = null;
        window.createNewDoc = async () => {
             const docRef = await addDoc(collection(db, "docs"), { userId: currentUser.uid, title: "Untitled Doc", content: "", updatedAt: serverTimestamp() });
             openDoc(docRef.id);
        };
        window.openDoc = async (id) => {
             currentDocId = id;
             const d = (await getDoc(doc(db, "docs", id))).data();
             document.getElementById('doc-title').value = d.title;
             document.getElementById('doc-content').value = d.content;
             document.getElementById('view-docs').children[1].classList.add('hidden-section'); // Hide list
             document.getElementById('doc-editor').classList.remove('hidden-section');
        };
        window.saveDoc = async () => {
             if(!currentDocId) return;
             await updateDoc(doc(db, "docs", currentDocId), {
                 title: document.getElementById('doc-title').value,
                 content: document.getElementById('doc-content').value,
                 updatedAt: serverTimestamp()
             });
             alert("Saved!");
        };
        window.closeDoc = () => {
             currentDocId = null;
             document.getElementById('doc-editor').classList.add('hidden-section');
             document.getElementById('view-docs').children[1].classList.remove('hidden-section');
        };

        // Table View & Bulk Actions
        window.renderTable = (list) => {
            const body = document.getElementById('table-body');
            body.innerHTML = list.map(t => `<tr class="hover:bg-slate-50 dark:hover:bg-slate-800 group"><td class="py-3 pl-2"><input type="checkbox" value="${t.id}" onchange="toggleSelect('${t.id}')"></td><td class="py-3 font-medium dark:text-white">${t.title}</td><td class="py-3 text-slate-500 flex items-center gap-2">${t.assignee ? `<div class="w-5 h-5 rounded-full bg-blue-100 flex items-center justify-center text-[10px] text-blue-600">A</div> ${t.assignee}` : '-'}</td><td class="py-3 text-slate-500">${t.dueDate||'-'}</td><td class="py-3"><span class="px-2 py-1 rounded text-xs ${t.priority==='High'?'bg-orange-100 text-orange-600':'bg-slate-100 text-slate-600'}">${t.priority}</span></td><td class="py-3 text-xs uppercase font-bold text-slate-400">${t.status}</td></tr>`).join('');
        };
        window.toggleSelect = (id) => { if(selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id); updateBulkUI(); };
        window.toggleSelectAll = (cb) => { selectedIds.clear(); if(cb.checked) tasks.filter(t=>!t.deletedAt).forEach(t=>selectedIds.add(t.id)); updateBulkUI(); renderTable(tasks.filter(t=>!t.deletedAt)); };
        function updateBulkUI() {
             const bar = document.getElementById('bulk-actions');
             document.getElementById('selected-count').textContent = `${selectedIds.size} Selected`;
             if(selectedIds.size > 0) bar.classList.remove('hidden-section'); else bar.classList.add('hidden-section');
        }
        window.bulkDelete = async () => { const batch = writeBatch(db); selectedIds.forEach(id => batch.update(doc(db, "tasks", id), {deletedAt: serverTimestamp()})); await batch.commit(); selectedIds.clear(); updateBulkUI(); };
        window.bulkComplete = async () => { const batch = writeBatch(db); selectedIds.forEach(id => batch.update(doc(db, "tasks", id), {status: 'Done'})); await batch.commit(); selectedIds.clear(); updateBulkUI(); };

        // Core Task Logic (Create, Edit, Delete)
        window.triggerQuickAdd = async () => {
             const title = document.getElementById('quick-add-input').value;
             if(!title) return;
             await addDoc(collection(db, "tasks"), { userId: currentUser.uid, title, status: 'Todo', priority: 'Medium', dueDate: document.getElementById('quick-add-date').value||null, createdAt: serverTimestamp() });
             document.getElementById('quick-add-input').value = '';
        };
        window.toggleStatus = async (id, s) => { 
             const n = s === 'Done' ? 'Todo' : 'Done';
             // XP Logic
             if(n === 'Done') {
                 confetti({particleCount: 50, spread: 60, origin: {y: 0.7}});
                 const userRef = doc(db, "userProfiles", currentUser.uid);
                 const snap = await getDoc(userRef);
                 let xp = (snap.data().totalXP || 0) + 10;
                 let title = xp > 1000 ? "Legend" : (xp > 500 ? "Master" : (xp > 100 ? "Pro" : "Novice"));
                 await updateDoc(userRef, { totalXP: xp, title: title });
             }
             await updateDoc(doc(db, "tasks", id), { status: n });
        };

        // UI Helpers
        window.openAddModal = () => document.getElementById('add-modal').classList.remove('hidden-section');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden-section');
        window.toggleSidebar = () => { const sb = document.getElementById('sidebar'); const ov = document.getElementById('mobile-overlay'); if(sb.style.marginLeft === '0px') { sb.style.marginLeft = '-18rem'; ov.classList.remove('open'); } else { sb.style.marginLeft = '0px'; ov.classList.add('open'); } };
        window.selectTask = (id) => { selectedTaskId = id; const t = tasks.find(x=>x.id===id); document.getElementById('detail-title').value = t.title; document.getElementById('detail-due').value = t.dueDate||''; document.getElementById('detail-assignee').value = t.assignee||''; document.getElementById('detail-panel').classList.remove('hidden-section'); setTimeout(()=>document.getElementById('active-detail').classList.remove('hidden-section'), 50); };
        window.closeDetail = () => { document.getElementById('detail-panel').classList.add('hidden-section'); };
        window.updateTaskDetail = async (k, v) => { if(selectedTaskId) await updateDoc(doc(db, "tasks", selectedTaskId), { [k]: v }); };
        window.softDeleteTask = async () => { if(selectedTaskId) await updateDoc(doc(db, "tasks", selectedTaskId), {deletedAt: serverTimestamp()}); closeDetail(); };
        window.renderTaskRow = (t) => `<div onclick="selectTask('${t.id}')" class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-3 flex items-center gap-3 cursor-pointer mb-2"><button onclick="event.stopPropagation(); toggleStatus('${t.id}','${t.status}')" class="w-6 h-6 rounded-full border-2 flex items-center justify-center ${t.status==='Done'?'bg-blue-500 border-blue-500 text-white':'border-slate-300'}"><i class="ph ph-check text-xs"></i></button><span class="${t.status==='Done'?'line-through text-slate-400':''} flex-1">${t.title}</span><div class="text-xs text-slate-400">${t.dueDate||''}</div></div>`;
        
        // Standard Setup
        window.showAuth = () => { document.getElementById('landing-page').classList.add('hidden-section'); document.getElementById('auth-screen').classList.remove('hidden-section'); };
        window.toggleDarkMode = () => { document.documentElement.classList.toggle('dark'); };
        document.getElementById('google-signin').addEventListener('click', () => signInWithPopup(auth, new GoogleAuthProvider()));
    </script>
</body>
</html>
